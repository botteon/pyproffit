

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyproffit.power_spectrum &mdash; pyproffit 0.5 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> pyproffit
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyproffit.html">API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyproffit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyproffit.power_spectrum</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyproffit.power_spectrum</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">Planck15</span> <span class="k">as</span> <span class="n">cosmo</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gamma</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">Yofn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">11.</span> <span class="o">/</span> <span class="mf">3.</span>  <span class="c1"># Kolmogorov slope</span>
<span class="n">cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">(</span><span class="mf">3.</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">(</span>
    <span class="mf">3.</span><span class="p">)</span>  <span class="c1"># correction factor for power spectrum, Arevalo et al. Eq. B1</span>
<span class="n">a3d</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Fractional perturbations</span>


<span class="c1"># Function to Mexican Hat filter images at a given scale sc</span>
<div class="viewcode-block" id="calc_mexicanhat"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.calc_mexicanhat">[docs]</a><span class="k">def</span> <span class="nf">calc_mexicanhat</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">simmod</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter an input image with a Mexican-hat filter</span>

<span class="sd">    :param sc: Mexican Hat scale in pixel</span>
<span class="sd">    :type sc: float</span>
<span class="sd">    :param img: Image to be smoothed</span>
<span class="sd">    :type img: class:`numpy.ndarray`</span>
<span class="sd">    :param mask: Mask image</span>
<span class="sd">    :type mask: class:`numpy.ndarray`</span>
<span class="sd">    :param simmod: Model surface brightness image</span>
<span class="sd">    :type simmod: class:`numpy.ndarray`</span>
<span class="sd">    :return: Mexican Hat convolved image and SB model</span>
<span class="sd">    :rtype: class:`numpy.ndarray`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define Gaussian convolution kernel</span>
    <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">gf</span><span class="p">[</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">gfm</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
    <span class="n">gfp</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
    <span class="c1"># FFT-convolve image with the two scales</span>
    <span class="n">gsigma1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gfm</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">gsigma2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="c1"># FFT-convolve mask with the two scales</span>
    <span class="n">gmask1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">gfm</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">gmask2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="c1"># FFT-convolve model with the two scales</span>
    <span class="n">gbeta1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">simmod</span><span class="p">,</span> <span class="n">gfm</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">gbeta2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">simmod</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="c1"># Eq. 6 of Arevalo et al. 2012</span>
    <span class="n">fout1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">gsigma1</span><span class="p">,</span> <span class="n">gmask1</span><span class="p">))</span>
    <span class="n">fout2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">gsigma2</span><span class="p">,</span> <span class="n">gmask2</span><span class="p">))</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="p">(</span><span class="n">fout1</span> <span class="o">-</span> <span class="n">fout2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="c1"># Same for simulated model</span>
    <span class="n">bout1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">gbeta1</span><span class="p">,</span> <span class="n">gmask1</span><span class="p">))</span>
    <span class="n">bout2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">gbeta2</span><span class="p">,</span> <span class="n">gmask2</span><span class="p">))</span>
    <span class="n">bout</span> <span class="o">=</span> <span class="p">(</span><span class="n">bout1</span> <span class="o">-</span> <span class="n">bout2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="k">return</span> <span class="n">fout</span><span class="p">,</span> <span class="n">bout</span></div>


<span class="c1"># Bootstrap function to compute the covariance matrix</span>
<div class="viewcode-block" id="do_bootstrap"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.do_bootstrap">[docs]</a><span class="k">def</span> <span class="nf">do_bootstrap</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">nsample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the covariance matrix of power spectra by bootstrapping the image</span>

<span class="sd">    :param vals: Set of values</span>
<span class="sd">    :type vals: class:`numpy.ndarray`</span>
<span class="sd">    :param nsample: Number of bootstrap samples</span>
<span class="sd">    :type nsample: int</span>
<span class="sd">    :return: 2D covariance matrix</span>
<span class="sd">    :rtype: class:`numpy.ndarray`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nval</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nsc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">vout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nsc</span><span class="p">,</span> <span class="n">nsample</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsample</span><span class="p">):</span>
        <span class="n">idb</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">nval</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nval</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsc</span><span class="p">):</span>
            <span class="n">vout</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idb</span><span class="p">])</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">vout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cov</span></div>


<div class="viewcode-block" id="calc_ps"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.calc_ps">[docs]</a><span class="k">def</span> <span class="nf">calc_ps</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">kr</span><span class="p">,</span> <span class="n">nreg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to compute the power at a given scale kr from the Mexican Hat filtered images</span>

<span class="sd">    :param region: Index defining the region from which the power spectrum will be extracted</span>
<span class="sd">    :type region: class:`numpy.ndarray`</span>
<span class="sd">    :param img: Mexican Hat filtered image</span>
<span class="sd">    :type img: class:`numpy.ndarray`</span>
<span class="sd">    :param mod: Mexican Hat filtered SB model</span>
<span class="sd">    :type mod: class:`numpy.ndarray`</span>
<span class="sd">    :param kr: Extraction scale</span>
<span class="sd">    :type kr: float</span>
<span class="sd">    :param nreg: Number of subregions into which the image should be splitted to perform the bootstrap</span>
<span class="sd">    :type nreg: int</span>
<span class="sd">    :return:</span>
<span class="sd">            - ps (float): Power at scale kr</span>
<span class="sd">            - psnoise (float): Noise at scale kr</span>
<span class="sd">            - vals (class:`numpy.ndarray`): set of values for bootstrap error calculation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>  <span class="c1"># Eq. 17 of Churazov et al. 2012</span>
    <span class="n">vmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span> <span class="o">-</span> <span class="n">vmod</span><span class="p">)</span> <span class="o">/</span> <span class="n">epsilon</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Yofn</span> <span class="o">/</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">psnoise</span> <span class="o">=</span> <span class="n">vmod</span> <span class="o">/</span> <span class="n">epsilon</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Yofn</span> <span class="o">/</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="c1"># amp=np.sqrt(ps*2.*np.pi*kr**2)</span>
    <span class="c1"># Compute power in subregions</span>
    <span class="n">nptot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nreg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nreg</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">nptot</span> <span class="o">/</span> <span class="n">nreg</span><span class="p">)</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">region</span><span class="p">][</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">region</span><span class="p">][</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Yofn</span> <span class="o">*</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ps</span><span class="p">,</span> <span class="n">psnoise</span><span class="p">,</span> <span class="n">vals</span></div>


<span class="c1"># 3D density for beta model</span>
<div class="viewcode-block" id="betamodel"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.betamodel">[docs]</a><span class="k">def</span> <span class="nf">betamodel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">rc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>


<span class="c1"># 3D density for double beta model</span>
<div class="viewcode-block" id="doublebeta"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.doublebeta">[docs]</a><span class="k">def</span> <span class="nf">doublebeta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rc1</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rc2</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">base1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">rc1</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">base2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">rc2</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">beta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span></div>


<span class="c1"># Function to compute numerically the 2D to 3D deprojection factor</span>
<div class="viewcode-block" id="calc_projection_factor"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.calc_projection_factor">[docs]</a><span class="k">def</span> <span class="nf">calc_projection_factor</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">betaparams</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute numerically the 2D to 3D deprojection factor. The routine is simulating 3D fluctuations using the surface brightness model and the region mask, projecting the 3D data along one axis, and computing the ratio of 2D to 3D power as a function of scale.</span>

<span class="sd">    Caution: this is a memory intensive computation which will run into memory overflow if the image size is too large or the available memory is insufficient.</span>

<span class="sd">    :param nn: Image size in pixel</span>
<span class="sd">    :type nn: int</span>
<span class="sd">    :param mask: Array defining the mask of active pixels, of size (nn , nn)</span>
<span class="sd">    :type mask: class:`numpy.ndarray`</span>
<span class="sd">    :param betaparams: Parameters of the beta model or double beta model</span>
<span class="sd">    :type betaparams: class:`numpy.ndarray`</span>
<span class="sd">    :param scale: Array of scales at which the projection factor should be computed</span>
<span class="sd">    :type scale: class:`numpy.ndarray`</span>
<span class="sd">    :return: Array containing wave number, 2D power, 2D amplitude, and 3D power</span>
<span class="sd">    :rtype: class:`numpy.ndarray`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tinit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># params defining cutoff scales in ADIM UNITS, i.e. divide by (2PI/L)</span>
    <span class="n">wave_cutoff_largek</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># nn/4. ;small scales cutoff || nn/2 is max possible (Nyquist)</span>
    <span class="n">wave_cutoff_smallk</span> <span class="o">=</span> <span class="mf">2.</span>  <span class="c1"># large scales cutoff; AT LEAST k &gt; 0.! if k^-alpha</span>

    <span class="c1"># note: these k are 3D, BUT same for 1D because L_3d/dr = L_x/dx</span>

    <span class="c1"># ******* ARRAY DECLARATION **********</span>
    <span class="n">tinit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing 3D k-space ... &#39;</span><span class="p">)</span>

    <span class="n">kxq</span><span class="p">,</span> <span class="n">kyq</span><span class="p">,</span> <span class="n">kzq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">))</span>
    <span class="n">lfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kxq</span> <span class="o">&gt;</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">kxq</span><span class="p">[</span><span class="n">lfr</span><span class="p">]</span> <span class="o">=</span> <span class="n">kxq</span><span class="p">[</span><span class="n">lfr</span><span class="p">]</span> <span class="o">-</span> <span class="n">nn</span>
    <span class="n">mfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kyq</span> <span class="o">&gt;</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">kyq</span><span class="p">[</span><span class="n">mfr</span><span class="p">]</span> <span class="o">=</span> <span class="n">kyq</span><span class="p">[</span><span class="n">mfr</span><span class="p">]</span> <span class="o">-</span> <span class="n">nn</span>
    <span class="n">nfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kzq</span> <span class="o">&gt;</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">kzq</span><span class="p">[</span><span class="n">nfr</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzq</span><span class="p">[</span><span class="n">nfr</span><span class="p">]</span> <span class="o">-</span> <span class="n">nn</span>
    <span class="n">k3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kxq</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">kyq</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">kzq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ******* PERTURBATIONS in k-space **********</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing fluctuations in the k-space ... &#39;</span><span class="p">)</span>

    <span class="n">cube</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">*</span> <span class="n">nn</span> <span class="o">*</span> <span class="n">nn</span>

    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k3D</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">))</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">k3D</span> <span class="o">&lt;=</span> <span class="n">wave_cutoff_smallk</span><span class="p">,</span> <span class="n">k3D</span> <span class="o">&gt;</span> <span class="n">wave_cutoff_largek</span><span class="p">))</span>
    <span class="n">amp</span><span class="p">[</span><span class="n">cut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">gauss1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nn</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">)</span>
    <span class="n">gauss2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nn</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">)</span>
    <span class="n">akx</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">(</span><span class="n">gauss1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">gauss2</span><span class="p">)</span>

    <span class="c1"># ******* INVERSE FOURIER TRANSFORM **********</span>
    <span class="c1"># DISCRETE (IDFT): x_n = 1/N * SUM (k=0 --&gt; N-1) X_k * exp(2PI*i*(k/N)*n)</span>
    <span class="c1"># with n = 0, ..., N-1 ; X_k --&gt; complex numb == represents amplitude</span>
    <span class="c1"># and phase of different sinusoidal components of input &#39;signal&#39; x_n:</span>
    <span class="c1"># AMPLITUDE A_k   = |X_k|    = sqrt(Re(X_k)^2 + Im(X_k)^2)</span>
    <span class="c1"># PHASE     phi_k = arg(X_k) = atan2(Im(X_k),Re(X_k))</span>
    <span class="c1"># FREQUENCY of each sinusoidal == k/N (cycles per sample)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing inverse 3D FFT  ... &#39;</span><span class="p">)</span>

    <span class="n">bx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">akx</span><span class="p">)</span>  <span class="c1"># note: 3D FFT --&gt; k along (nn,nn,nn) ;PARALLEL</span>
   <span class="c1"># print(&#39;MINIMUM amp delta_k is: &#39;, np.min(np.absolute(akx)))</span>
   <span class="c1"># print(&#39;MAXIMUM amp delta_k is: &#39;, np.max(np.absolute(akx)))</span>

    <span class="c1"># find normalization (rms, mean 0.)</span>
    <span class="c1"># note: bx is COMPLEX =&gt; take real part</span>
    <span class="n">avbx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">bx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">cube</span><span class="p">)</span>
    <span class="c1"># normalize fluctuations such that sigma=1</span>
    <span class="n">fluct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">bx</span><span class="p">)</span> <span class="o">/</span> <span class="n">avbx</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS (= 1 sigma) delta_x is: &#39;</span><span class="p">,</span> <span class="n">avbx</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum (real) delta_x/rms is: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fluct</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum (real) delta_x/rms is: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fluct</span><span class="p">))</span>

    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">fluct</span><span class="p">)</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;fluctuations.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;3D fluctuations field saved to fluctuations.fits&#39;</span><span class="p">)</span>

    <span class="c1"># Read data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Now computing 2D and 3D power spectra...&#39;</span><span class="p">)</span>

    <span class="c1"># ******* PROJECT AND CONVOLVE WITH BETA MODEL **********</span>

    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="n">cone</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cone</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">nn</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>  <span class="c1"># Set center at the middle of the cube</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="p">))</span>
    <span class="n">rads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">betaparams</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npar</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">rho_unpert</span> <span class="o">=</span> <span class="n">betamodel</span><span class="p">(</span><span class="n">rads</span><span class="p">,</span> <span class="n">betaparams</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rho_unpert</span> <span class="o">=</span> <span class="n">doublebeta</span><span class="p">(</span><span class="n">rads</span><span class="p">,</span> <span class="n">betaparams</span><span class="p">)</span>

    <span class="n">em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rho_unpert</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">a3d</span> <span class="o">*</span> <span class="n">fluct</span><span class="p">),</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">em3d</span> <span class="o">=</span> <span class="n">em</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rho_unpert</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rho_unpert</span><span class="p">,</span> <span class="mf">2.</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">imgo</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">imgo</span><span class="p">,</span> <span class="n">mod</span><span class="p">))</span>

    <span class="n">nsc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flucts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Convolve the image with the given scales</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convolving images with Mexican Hat filters&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsc</span><span class="p">):</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convolving with scale &#39;</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nn</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">gf</span><span class="p">[</span><span class="n">center</span><span class="p">,</span> <span class="n">center</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">gfm</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="n">gfp</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="c1"># Convolve image with the two scales</span>
        <span class="n">gsigma1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gfm</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">gsigma2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="c1"># Convolve 3D fluctuation field</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">))</span>
        <span class="n">gf</span><span class="p">[</span><span class="n">center</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">gfm</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="n">gfp</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">sc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="n">gfluct1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">em3d</span><span class="p">,</span> <span class="n">gfm</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">gfluct2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">em3d</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="c1"># Eq. 6 of Arevalo et al. 2012</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="n">gsigma1</span> <span class="o">-</span> <span class="n">gsigma2</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>

        <span class="n">ffluct</span> <span class="o">=</span> <span class="n">gfluct1</span> <span class="o">-</span> <span class="n">gfluct2</span>
        <span class="n">flucts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffluct</span><span class="p">)</span>

    <span class="c1"># Compute power spectrum in nreg independent subregions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing 2D and 3D power spectra...&#39;</span><span class="p">)</span>
    <span class="c1"># size=np.double(nlin)/2./np.pi</span>
    <span class="n">kr</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">Yofn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">Yofn3d</span> <span class="o">=</span> <span class="mf">15.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">3.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c1"># Applying mask to 2D images to correct for missing area due to gaps and point sources</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ps</span><span class="p">,</span> <span class="n">ps3d</span><span class="p">,</span> <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsc</span><span class="p">):</span>
        <span class="n">tkr</span> <span class="o">=</span> <span class="n">kr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">timg</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">nonzero</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">timg</span><span class="p">)</span>  <span class="c1"># Eq. 17 of Churazov et al. 2012</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="n">epsilon</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Yofn</span> <span class="o">/</span> <span class="n">tkr</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># no noise</span>
        <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
        <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tp</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">tkr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># 3D</span>
        <span class="n">t3d</span> <span class="o">=</span> <span class="n">flucts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">v3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">t3d</span><span class="p">)</span> <span class="o">/</span> <span class="n">epsilon</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Yofn3d</span> <span class="o">/</span> <span class="n">tkr</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="n">ps3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v3d</span>

    <span class="c1"># Save data into file</span>
    <span class="n">pout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">kr</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ps3d</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;conv2d3d.txt&#39;</span><span class="p">,</span> <span class="n">pout</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results written in file conv2d3d.txt&#39;</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Total computing time is: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39; minutes&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pout</span></div>


<div class="viewcode-block" id="PowerSpectrum"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum">[docs]</a><span class="k">class</span> <span class="nc">PowerSpectrum</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to perform fluctuation power spectrum analysis from Poisson count images. This is the code used in Eckert et al. 2017.</span>

<span class="sd">    :param data: Object of type :class:`pyproffit.data.Data` including the image, exposure map, background map, and region definition</span>
<span class="sd">    :type data: class:`pyproffit.data.Data`</span>
<span class="sd">    :param profile: Object of type :class:`pyproffit.profextract.Profile` including the extracted surface brightness profile</span>
<span class="sd">    :type profile: class:`pyproffit.profextract.Profile`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for class PowerSpectrum</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>

<div class="viewcode-block" id="PowerSpectrum.MexicanHat"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum.MexicanHat">[docs]</a>    <span class="k">def</span> <span class="nf">MexicanHat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modimg_file</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">factshift</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convolve the input image and model image with a set of Mexican Hat filters at various scales. The convolved images are automatically stored into FITS images called conv_scale_xx.fits and conv_beta_xx.fits, with xx the scale in kpc.</span>

<span class="sd">        :param modimg_file: Path to a FITS file including the model image, typically produced with :meth:`pyproffit.profextract.Profile.SaveModelImage`</span>
<span class="sd">        :type modimg_file: str</span>
<span class="sd">        :param z: Source redshift</span>
<span class="sd">        :type z: float</span>
<span class="sd">        :param region_size: Size of the region of interest in Mpc. Defaults to 1.0</span>
<span class="sd">        :type region_size: float</span>
<span class="sd">        :param factshift: Size of the border around the region, i.e. a region of size factshift * region_size is used for the computation. Defaults to 1.5</span>
<span class="sd">        :type factshift: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imgo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">img</span>
        <span class="n">expo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exposure</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">bkg</span>
        <span class="n">pixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pixsize</span>
        <span class="c1"># Read model image</span>
        <span class="n">fmod</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">modimg_file</span><span class="p">)</span>
        <span class="n">modimg</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1"># Define the mask</span>
        <span class="n">nonz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expo</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">masko</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">expo</span><span class="p">)</span>
        <span class="n">masko</span><span class="p">[</span><span class="n">nonz</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">imgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">imgo</span><span class="p">)</span>
        <span class="n">noexp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expo</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">imgt</span><span class="p">[</span><span class="n">noexp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Set the region of interest</span>
        <span class="n">x_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cx</span>  <span class="c1"># Center coordinates</span>
        <span class="n">y_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cy</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Mpcpix</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">/</span> <span class="n">kpcp</span> <span class="o">/</span> <span class="n">pixsize</span>  <span class="c1"># 1 Mpc in pixel</span>
        <span class="n">regsizepix</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">*</span> <span class="n">Mpcpix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regsize</span> <span class="o">=</span> <span class="n">regsizepix</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_c</span> <span class="o">-</span> <span class="n">factshift</span> <span class="o">*</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_c</span> <span class="o">+</span> <span class="n">factshift</span> <span class="o">*</span> <span class="n">regsizepix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_c</span> <span class="o">-</span> <span class="n">factshift</span> <span class="o">*</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_c</span> <span class="o">+</span> <span class="n">factshift</span> <span class="o">*</span> <span class="n">regsizepix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">minx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">minx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">miny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">miny</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">maxx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">maxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">maxy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">imgt</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">],</span> <span class="n">modimg</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">masko</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="n">fmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="n">fmod</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;mask.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Simulate perfect model with Poisson noise</span>
        <span class="n">randmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">modimg</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">])</span>
        <span class="n">simmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">randmod</span><span class="p">,</span> <span class="n">modimg</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]))</span>
        <span class="c1"># Set the scales</span>
        <span class="n">minscale</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># minimum scale of 2 pixels</span>
        <span class="n">maxscale</span> <span class="o">=</span> <span class="n">regsizepix</span> <span class="o">/</span> <span class="mf">2.</span> <span class="c1"># at least 4 resolution elements on a side</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minscale</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxscale</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 scale logarithmically spaced</span>
        <span class="n">sckpc</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">pixsize</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="c1"># Convolve images</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convolving with scale&#39;</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
            <span class="n">convimg</span><span class="p">,</span> <span class="n">convmod</span> <span class="o">=</span> <span class="n">calc_mexicanhat</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">simmod</span><span class="p">)</span>
            <span class="c1"># Save image</span>
            <span class="n">fmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convimg</span>
            <span class="n">fmod</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;conv_scale_</span><span class="si">%d</span><span class="s1">_kpc.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sckpc</span><span class="p">[</span><span class="n">i</span><span class="p">]))),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convmod</span>
            <span class="n">fmod</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;conv_model_</span><span class="si">%d</span><span class="s1">_kpc.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sckpc</span><span class="p">[</span><span class="n">i</span><span class="p">]))),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fmod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">#</span>
<div class="viewcode-block" id="PowerSpectrum.PS"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum.PS">[docs]</a>    <span class="k">def</span> <span class="nf">PS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">radius_in</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">radius_out</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute the power spectrum from existing Mexican Hat images in a given circle or annulus</span>

<span class="sd">        :param z: Source redshift</span>
<span class="sd">        :type z: float</span>
<span class="sd">        :param region_size: Size of the region of interest in Mpc. Defaults to 1.0. This value must be equal to the region_size parameter used in :meth:`pyproffit.power_spectrum.PowerSpectrum.MexicanHat`.</span>
<span class="sd">        :type region_size: float</span>
<span class="sd">        :param radius_in: Inner boundary in Mpc of the annulus to be used. Defaults to 0.0</span>
<span class="sd">        :type radius_in: float</span>
<span class="sd">        :param radius_out: Outer boundary in Mpc of the annulus to be used. Defaults to 1.0</span>
<span class="sd">        :type radius_out: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Mpcpix</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">/</span> <span class="n">kpcp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pixsize</span>  <span class="c1"># 1 Mpc in pixel</span>
        <span class="n">regsizepix</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">*</span> <span class="n">Mpcpix</span>
        <span class="c1">######################</span>
        <span class="c1"># Set the scales</span>
        <span class="c1">######################</span>
        <span class="n">minscale</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># minimum scale of 2 pixels</span>
        <span class="n">maxscale</span> <span class="o">=</span> <span class="n">regsizepix</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minscale</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxscale</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 scale logarithmically spaced</span>
        <span class="n">sckpc</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pixsize</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="n">kr</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># Eq. A5 of Arevalo et al. 2012</span>
        <span class="c1">######################</span>
        <span class="c1"># Define the region where the power spectrum will be extracted</span>
        <span class="c1">######################</span>
        <span class="n">fmask</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;mask.fits&#39;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">fmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fmask</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">data_size</span><span class="p">)</span>
        <span class="n">rads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">data_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rads</span> <span class="o">&gt;</span> <span class="n">radius_in</span> <span class="o">*</span> <span class="n">Mpcpix</span><span class="p">,</span> <span class="n">rads</span> <span class="o">&lt;=</span> <span class="n">radius_out</span> <span class="o">*</span> <span class="n">Mpcpix</span><span class="p">),</span> <span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="c1">######################</span>
        <span class="c1"># Extract the PS from the various images</span>
        <span class="c1">######################</span>
        <span class="n">nsc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">ps</span><span class="p">,</span> <span class="n">psnoise</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">eamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nreg</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Number of subregions for bootstrap calculation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsc</span><span class="p">):</span>
            <span class="c1"># Read images</span>
            <span class="n">fco</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;conv_scale_</span><span class="si">%d</span><span class="s1">_kpc.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sckpc</span><span class="p">[</span><span class="n">i</span><span class="p">]))))</span>
            <span class="n">convimg</span> <span class="o">=</span> <span class="n">fco</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">fco</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">fmod</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;conv_model_</span><span class="si">%d</span><span class="s1">_kpc.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sckpc</span><span class="p">[</span><span class="n">i</span><span class="p">]))))</span>
            <span class="n">convmod</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">fmod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing the power at scale&#39;</span><span class="p">,</span> <span class="n">sckpc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;kpc&#39;</span><span class="p">)</span>
            <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psnoise</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vps</span> <span class="o">=</span> <span class="n">calc_ps</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">convimg</span><span class="p">,</span> <span class="n">convmod</span><span class="p">,</span> <span class="n">kr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nreg</span><span class="p">)</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vps</span><span class="p">)</span>
        <span class="c1"># Bootstrap the data and compute covariance matrix</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing the covariance matrix...&#39;</span><span class="p">)</span>
        <span class="n">nboot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>  <span class="c1"># number of bootstrap resamplings</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">do_bootstrap</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">nboot</span><span class="p">)</span>
        <span class="c1"># compute eigenvalues of covariance matrix to verify that the matrix is positive definite</span>
        <span class="n">la</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eigenvalues: &#39;</span><span class="p">,</span> <span class="n">la</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsc</span><span class="p">):</span>
            <span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cf</span><span class="p">)</span>
        <span class="n">eamp</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cf</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cf</span> <span class="o">*</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpix</span> <span class="o">=</span> <span class="n">kr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">sckpc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psnoise</span> <span class="o">=</span> <span class="n">psnoise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">amp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eamp</span> <span class="o">=</span> <span class="n">eamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="PowerSpectrum.Plot"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum.Plot">[docs]</a>    <span class="k">def</span> <span class="nf">Plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outps</span><span class="o">=</span><span class="s1">&#39;power_spectrum.pdf&#39;</span><span class="p">,</span> <span class="n">outamp</span><span class="o">=</span><span class="s1">&#39;a2d.pdf&#39;</span><span class="p">,</span> <span class="n">plot_3d</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cfact</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the loaded power spectrum</span>

<span class="sd">        :param save_plots: Indicate whether the plot should be saved to disk or not. Defaults to True.</span>
<span class="sd">        :type save_plots: bool</span>
<span class="sd">        :param outps: Name of output file. Defaults to &#39;power_spectrum.pdf&#39;</span>
<span class="sd">        :type outps: str</span>
<span class="sd">        :param outamp: Name of output file to save the 2D amplitude plot. Defaults to &#39;a2d.pdf&#39;</span>
<span class="sd">        :type outamp: str</span>
<span class="sd">        :param plot_3d: Add or not the 3D power spectrum to the plot. Defaults to False</span>
<span class="sd">        :type plot_3d: bool</span>
<span class="sd">        :param cfact: 2D to 3D projection factor</span>
<span class="sd">        :type cfact: class:`numpy.ndarray` , optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No power spectrum exists in structure&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                   <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k [kpc$^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;2D Power&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;P$_</span><span class="si">{2D}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psnoise</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Poisson noise&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_3d</span><span class="p">:</span>
            <span class="n">kcf</span> <span class="o">=</span> <span class="n">cfact</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">cfact</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">cfact</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">interp_cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpix</span><span class="p">,</span><span class="n">kcf</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span>
            <span class="n">ps3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">*</span> <span class="n">interp_cf</span>
            <span class="n">eps3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">interp_cf</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">ps3d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;P$_</span><span class="si">{3D}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">ps3d</span> <span class="o">-</span> <span class="n">eps3d</span><span class="p">,</span> <span class="n">ps3d</span> <span class="o">+</span> <span class="n">eps3d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                   <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k [kpc$^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$A_</span><span class="si">{2D}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;A$_</span><span class="si">{2D}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eamp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_3d</span><span class="p">:</span>
            <span class="n">a3d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ps3d</span><span class="o">*</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kpix</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">ea3d</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ps3d</span><span class="o">*</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kpix</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kpix</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">eps3d</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">a3d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;A$_</span><span class="si">{3D}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">a3d</span> <span class="o">-</span> <span class="n">ea3d</span><span class="p">,</span> <span class="n">a3d</span> <span class="o">+</span> <span class="n">ea3d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outamp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="PowerSpectrum.Save"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum.Save">[docs]</a>    <span class="k">def</span> <span class="nf">Save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">outcov</span><span class="o">=</span><span class="s1">&#39;covariance.txt&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the loaded power spectra to an output ASCII file</span>

<span class="sd">        :param outfile: Name of output ASCII file</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :param outcov: Output covariance matrix. Defaults to &#39;covariance.txt&#39;</span>
<span class="sd">        :type outcov: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Nothing to save&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psnoise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eamp</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">header</span><span class="o">=</span><span class="s1">&#39;k/kpc-1  PS2D  dPS2D  Noise  A2D  dA2D&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outcov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">)</span></div>

<div class="viewcode-block" id="PowerSpectrum.ProjectionFactor"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.power_spectrum.PowerSpectrum.ProjectionFactor">[docs]</a>    <span class="k">def</span> <span class="nf">ProjectionFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">betaparams</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute numerically the 2D to 3D deprojection factor. The routine is simulating 3D fluctuations using the surface brightness model and the region mask, projecting the 3D data along one axis, and computing the ratio of 2D to 3D power as a function of scale.</span>

<span class="sd">        Caution: this is a memory intensive computation which will run into memory overflow if the image size is too large or the available memory is insufficient.</span>

<span class="sd">        :param z: Source redshift</span>
<span class="sd">        :type z: float</span>
<span class="sd">        :param betaparams: Parameters of the beta model or double beta model</span>
<span class="sd">        :type betaparams: class:`numpy.ndarray`</span>
<span class="sd">        :param region_size: Size of the region of interest in Mpc. Defaults to 1.0. This value must be equal to the region_size parameter used in :meth:`pyproffit.power_spectrum.PowerSpectrum.MexicanHat`.</span>
<span class="sd">        :type region_size: float</span>
<span class="sd">        :return: Array of projection factors</span>
<span class="sd">        :rtype: class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pixsize</span>
        <span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">betaparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npar</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We will use a single beta profile&#39;</span><span class="p">)</span>
            <span class="n">betaparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">betaparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixsize</span>
            <span class="n">betaparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">elif</span> <span class="n">npar</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We will use a double beta profile&#39;</span><span class="p">)</span>
            <span class="n">betaparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">betaparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixsize</span>
            <span class="n">betaparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">betaparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixsize</span>
            <span class="n">betaparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid number of SB parameters&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">fmask</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;mask.fits&#39;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">fmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fmask</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Mpcpix</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">/</span> <span class="n">kpcp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pixsize</span>  <span class="c1"># 1 Mpc in pixel</span>
        <span class="n">regsizepix</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">*</span> <span class="n">Mpcpix</span>
        <span class="k">if</span> <span class="n">regsizepix</span><span class="o">&gt;</span><span class="n">data_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: region size larger than image size&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">regsizepix</span><span class="p">))</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">minscale</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># minimum scale of 2 pixels</span>
        <span class="n">maxscale</span> <span class="o">=</span> <span class="n">regsizepix</span> <span class="o">/</span> <span class="mf">2.</span> <span class="c1"># at least 4 resolution elements on a side</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minscale</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxscale</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 scale logarithmically spaced</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfact</span> <span class="o">=</span> <span class="n">calc_projection_factor</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">msk</span><span class="p">,</span> <span class="n">betaparams</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">cfact</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, D. Eckert

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>