

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyproffit.deproject &mdash; pyproffit 0.5 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> pyproffit
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyproffit.html">API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyproffit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyproffit.deproject</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyproffit.deproject</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="k">import</span> <span class="n">Planck15</span> <span class="k">as</span> <span class="n">cosmo</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">gamma</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#plt.switch_backend(&#39;Agg&#39;)</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

<span class="n">Mpc</span> <span class="o">=</span> <span class="mf">3.0856776e+24</span> <span class="c1">#cm</span>
<span class="n">kpc</span> <span class="o">=</span> <span class="mf">3.0856776e+21</span> <span class="c1">#cm</span>
<span class="n">msun</span> <span class="o">=</span> <span class="mf">1.9891e33</span> <span class="c1">#g</span>
<span class="n">mh</span> <span class="o">=</span> <span class="mf">1.66053904e-24</span> <span class="c1">#proton mass in g</span>


<div class="viewcode-block" id="plot_multi_methods"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.plot_multi_methods">[docs]</a><span class="k">def</span> <span class="nf">plot_multi_methods</span><span class="p">(</span><span class="n">profs</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot multiple gas density profiles (e.g. obtained through several methods, centers or sectors) to compare them</span>

<span class="sd">    :param profs: List of Profile objects to be plotted</span>
<span class="sd">    :type profs: tuple</span>
<span class="sd">    :param deps: List of Deproject objects to be plotted</span>
<span class="sd">    :type deps: tuple</span>
<span class="sd">    :param labels: List of labels for the legend (default=None)</span>
<span class="sd">    :type labels: tuple</span>
<span class="sd">    :param outfile: If outfile is not None, path to file name to output the plot</span>
<span class="sd">    :type outfile: str</span>
<span class="sd">    :return: matplotlib figure object</span>
<span class="sd">    :rtype: class:`matplotlib.figure`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: different numbers of profiles and deprojection elements&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Showing </span><span class="si">%d</span><span class="s2"> density profiles&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span>
               <span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">]</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [kpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$n_</span><span class="si">{H}</span><span class="s1">$ [cm$^{-3}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">)):</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">profs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">&lt;</span> <span class="n">dep</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="n">rkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="n">erkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span> <span class="o">*</span> <span class="n">kpcp</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">erkpc</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">dens</span> <span class="o">-</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens_lo</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens_hi</span> <span class="o">-</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens_lo</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">dens_hi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="fbul19"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.fbul19">[docs]</a><span class="k">def</span> <span class="nf">fbul19</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Runit</span><span class="o">=</span><span class="s1">&#39;kpc&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mgas from input R500 using Bulbul+19 M-Mgas scaling relation</span>

<span class="sd">    :param R: Input R500 value</span>
<span class="sd">    :type R: float</span>
<span class="sd">    :param z: Input redshift</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param Runit: Unit of input radis, kpc or arcmin (default=&#39;kpc&#39;)</span>
<span class="sd">    :type Runit: str</span>
<span class="sd">    :return: Mgas</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Runit</span> <span class="o">==</span> <span class="s1">&#39;arcmin&#39;</span><span class="p">:</span>
        <span class="n">amin2kpc</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="o">*</span><span class="n">amin2kpc</span>

    <span class="n">rho_cz</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Msun</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">efunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">efunc</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">rho_cz</span> <span class="o">*</span> <span class="n">R</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="n">zpiv</span> <span class="o">=</span> <span class="mf">0.45</span>
    <span class="n">Mpiv</span> <span class="o">=</span> <span class="mf">6.35e14</span>
    <span class="n">efuncpiv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">efunc</span><span class="p">(</span><span class="n">zpiv</span><span class="p">))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="mf">7.09</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mf">1.26</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.10</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.16</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.16</span>
    <span class="n">Bprime</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">zpiv</span><span class="p">))</span>

    <span class="n">Mgas</span> <span class="o">=</span> <span class="mf">1e13</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">/</span> <span class="n">Mpiv</span><span class="p">)</span> <span class="o">**</span> <span class="n">Bprime</span> <span class="o">*</span> <span class="p">(</span><span class="n">efunc</span> <span class="o">/</span> <span class="n">efuncpiv</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">zpiv</span><span class="p">))</span> <span class="o">**</span> <span class="n">gamma</span>

    <span class="k">return</span> <span class="n">Mgas</span></div>


<div class="viewcode-block" id="calc_linear_operator"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.calc_linear_operator">[docs]</a><span class="k">def</span> <span class="nf">calc_linear_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">sourcereg</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">expo</span><span class="p">,</span><span class="n">psf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate a linear operator transforming parameter vector into predicted model counts</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param sourcereg: Selection array for the source region</span>
<span class="sd">    :type sourcereg: numpy.ndarray</span>
<span class="sd">    :param pars: List of beta model parameters obtained through list_params</span>
<span class="sd">    :type pars: numpy.ndarray</span>
<span class="sd">    :param area: Bin area in arcmin^2</span>
<span class="sd">    :type area: numpy.ndarray</span>
<span class="sd">    :param expo: Bin effective exposure in s</span>
<span class="sd">    :type expo: numpy.ndarray</span>
<span class="sd">    :param psf: PSF mixing matrix</span>
<span class="sd">    :type psf: numpy.ndarray</span>
<span class="sd">    :return: Linear projection and PSF mixing operator</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select values in the source region</span>
    <span class="n">rfit</span><span class="o">=</span><span class="n">rad</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span>
    <span class="n">npt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">npars</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">areamul</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">],</span><span class="n">npars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">expomul</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">expo</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">],</span><span class="n">npars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">spsf</span><span class="o">=</span><span class="n">psf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">]</span>
    
    <span class="c1"># Compute linear combination of basis functions in the source region</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">base</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rfit</span><span class="o">/</span><span class="n">rc</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">expon</span><span class="o">=-</span><span class="mf">3.</span><span class="o">*</span><span class="n">beta</span><span class="o">+</span><span class="mf">0.5</span>
    <span class="n">func_base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">expon</span><span class="p">)</span>
    
    <span class="c1"># Predict number of counts per annulus and convolve with PSF</span>
    <span class="n">Ktrue</span><span class="o">=</span><span class="n">func_base</span><span class="o">*</span><span class="n">areamul</span><span class="o">*</span><span class="n">expomul</span>
    <span class="n">Kconv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spsf</span><span class="p">,</span><span class="n">Ktrue</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    
    <span class="c1"># Recast into full matrix and add column for background</span>
    <span class="n">nptot</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">Ktot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nptot</span><span class="p">,</span><span class="n">npars</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Ktot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="n">Kconv</span>
    <span class="n">Ktot</span><span class="p">[:,</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="n">area</span><span class="o">*</span><span class="n">expo</span>
    <span class="k">return</span> <span class="n">Ktot</span></div>

<span class="c1"># Function to create the list of parameters for the basis functions</span>
<span class="n">nsh</span><span class="o">=</span><span class="mf">4.</span> <span class="c1"># number of basis functions to set</span>

<div class="viewcode-block" id="list_params"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.list_params">[docs]</a><span class="k">def</span> <span class="nf">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">sourcereg</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define a list of parameters to define the dictionary of basis functions</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param sourcereg: Selection array for the source region</span>
<span class="sd">    :type sourcereg: numpy.ndarray</span>
<span class="sd">    :param nrc: Number of core radii. If nrc=None (default), the number of core radiis will be defined on-the-fly</span>
<span class="sd">    :type nrc: int</span>
<span class="sd">    :param nbetas: Number of beta values. Default=6</span>
<span class="sd">    :type nbetas: int</span>
<span class="sd">    :param min_beta: Minimum value of beta. Default=0.6</span>
<span class="sd">    :type min_beta: float</span>
<span class="sd">    :return: Array containing sets of values to set up the function dictionary</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rfit</span><span class="o">=</span><span class="n">rad</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span>
    <span class="n">npfit</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nrc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">npfit</span><span class="o">/</span><span class="n">nsh</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">allrc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rfit</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rfit</span><span class="p">[</span><span class="n">npfit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span><span class="n">nrc</span><span class="p">)</span>
    <span class="c1">#allbetas=np.linspace(0.4,3.,6)</span>
    <span class="n">allbetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_beta</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">)</span>
    <span class="n">nrc</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">allrc</span><span class="p">)</span>
    <span class="n">nbetas</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">allbetas</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">allrc</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nbetas</span><span class="p">)</span>
    <span class="n">betas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">allbetas</span><span class="p">,</span><span class="n">nrc</span><span class="p">)</span>
    <span class="n">ptot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nrc</span><span class="o">*</span><span class="n">nbetas</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ptot</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">betas</span>
    <span class="n">ptot</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">rc</span>
    <span class="k">return</span> <span class="n">ptot</span></div>

<span class="c1"># Function to create a linear operator transforming parameters into surface brightness</span>

<div class="viewcode-block" id="calc_sb_operator"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.calc_sb_operator">[docs]</a><span class="k">def</span> <span class="nf">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">sourcereg</span><span class="p">,</span><span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate a linear operator transforming parameter vector into surface brightness</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param sourcereg: Selection array for the source region</span>
<span class="sd">    :type sourcereg: numpy.ndarray</span>
<span class="sd">    :param pars: List of beta model parameters obtained through list_params</span>
<span class="sd">    :type pars: numpy.ndarray</span>
<span class="sd">    :return: Linear projection operator</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Select values in the source region</span>
    <span class="n">rfit</span><span class="o">=</span><span class="n">rad</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span>
    <span class="n">npt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">npars</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Compute linear combination of basis functions in the source region</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">base</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rfit</span><span class="o">/</span><span class="n">rc</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">expon</span><span class="o">=-</span><span class="mf">3.</span><span class="o">*</span><span class="n">beta</span><span class="o">+</span><span class="mf">0.5</span>
    <span class="n">func_base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">expon</span><span class="p">)</span>
    
    <span class="c1"># Recast into full matrix and add column for background</span>
    <span class="n">nptot</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">Ktot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nptot</span><span class="p">,</span><span class="n">npars</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Ktot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="n">func_base</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Ktot</span><span class="p">[:,</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">Ktot</span></div>


<div class="viewcode-block" id="calc_sb_operator_psf"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.calc_sb_operator_psf">[docs]</a><span class="k">def</span> <span class="nf">calc_sb_operator_psf</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">expo</span><span class="p">,</span> <span class="n">psf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Same as calc_sb_operator but convolving the model surface brightness with the PSF model</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param sourcereg: Selection array for the source region</span>
<span class="sd">    :type sourcereg: numpy.ndarray</span>
<span class="sd">    :param pars: List of beta model parameters obtained through list_params</span>
<span class="sd">    :type pars: numpy.ndarray</span>
<span class="sd">    :param area: Bin area in arcmin^2</span>
<span class="sd">    :type area: numpy.ndarray</span>
<span class="sd">    :param expo: Bin effective exposure in s</span>
<span class="sd">    :type expo: numpy.ndarray</span>
<span class="sd">    :param psf: PSF mixing matrix</span>
<span class="sd">    :type psf: numpy.ndarray</span>
<span class="sd">    :return: Linear projection and PSF mixing operator</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select values in the source region</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span>
    <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">npars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">areamul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">],</span> <span class="n">npars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">expomul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">expo</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">],</span> <span class="n">npars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">spsf</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">]</span>

    <span class="c1"># Compute linear combination of basis functions in the source region</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rfit</span> <span class="o">/</span> <span class="n">rc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">expon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">func_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">expon</span><span class="p">)</span>

    <span class="n">Ktrue</span> <span class="o">=</span> <span class="n">func_base</span> <span class="o">*</span> <span class="n">areamul</span> <span class="o">*</span> <span class="n">expomul</span>
    <span class="n">Kconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spsf</span><span class="p">,</span> <span class="n">Ktrue</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Recast into full matrix and add column for background</span>
    <span class="n">nptot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">Ktot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nptot</span><span class="p">,</span> <span class="n">npars</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">Ktot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kconv</span>
    <span class="n">Ktot</span><span class="p">[:,</span> <span class="n">npars</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="n">expo</span>
    <span class="k">return</span> <span class="n">Ktot</span></div>


<div class="viewcode-block" id="calc_int_operator"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.calc_int_operator">[docs]</a><span class="k">def</span> <span class="nf">calc_int_operator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a linear operator to integrate analytically the basis functions within some radial range and return count rate and luminosities</span>

<span class="sd">    :param a: Lower integration boundary</span>
<span class="sd">    :type a: float</span>
<span class="sd">    :param b: Upper integration boundary</span>
<span class="sd">    :type b: float</span>
<span class="sd">    :param pars: List of beta model parameters obtained through list_params</span>
<span class="sd">    :type pars: numpy.ndarray</span>
<span class="sd">    :return: Linear integration operator</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select values in the source region</span>
    <span class="n">npars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">rads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
    <span class="n">npt</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Compute linear combination of basis functions in the source region</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rads</span> <span class="o">/</span> <span class="n">rc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">expon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">func_base</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">expon</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">rc</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Recast into full matrix and add column for background</span>
    <span class="n">Kint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npt</span><span class="p">,</span> <span class="n">npars</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">Kint</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_base</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Kint</span><span class="p">[:,</span> <span class="n">npars</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">Kint</span></div>


<div class="viewcode-block" id="list_params_density"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.list_params_density">[docs]</a><span class="k">def</span> <span class="nf">list_params_density</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">sourcereg</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define a list of parameters to transform the basis functions into gas density profiles</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param sourcereg: Selection array for the source region</span>
<span class="sd">    :type sourcereg: numpy.ndarray</span>
<span class="sd">    :param z: Source redshift</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param nrc: Number of core radii. If nrc=None (default), the number of core radiis will be defined on-the-fly</span>
<span class="sd">    :type nrc: int</span>
<span class="sd">    :param nbetas: Number of beta values. Default=6</span>
<span class="sd">    :type nbetas: int</span>
<span class="sd">    :param min_beta: Minimum value of beta. Default=0.6</span>
<span class="sd">    :type min_beta: float</span>
<span class="sd">    :return: Array containing sets of values to set up the function dictionary</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rfit</span><span class="o">=</span><span class="n">rad</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">]</span>
    <span class="n">npfit</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">kpcp</span><span class="o">=</span><span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">nrc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">npfit</span><span class="o">/</span><span class="n">nsh</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">allrc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rfit</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rfit</span><span class="p">[</span><span class="n">npfit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span><span class="n">nrc</span><span class="p">)</span><span class="o">*</span><span class="n">kpcp</span>
    <span class="c1">#allbetas=np.linspace(0.5,3.,6)</span>
    <span class="n">allbetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_beta</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">)</span>
    <span class="n">nrc</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">allrc</span><span class="p">)</span>
    <span class="n">nbetas</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">allbetas</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">allrc</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nbetas</span><span class="p">)</span>
    <span class="n">betas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">allbetas</span><span class="p">,</span><span class="n">nrc</span><span class="p">)</span>
    <span class="n">ptot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nrc</span><span class="o">*</span><span class="n">nbetas</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ptot</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">betas</span>
    <span class="n">ptot</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">rc</span>
    <span class="k">return</span> <span class="n">ptot</span></div>

<span class="c1"># Linear operator to transform parameters into density</span>

<div class="viewcode-block" id="calc_density_operator"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.calc_density_operator">[docs]</a><span class="k">def</span> <span class="nf">calc_density_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute linear operator to transform parameters into gas density profiles</span>

<span class="sd">    :param rad: Array of input radii in arcmin</span>
<span class="sd">    :type rad: numpy.ndarray</span>
<span class="sd">    :param pars: List of beta model parameters obtained through list_params</span>
<span class="sd">    :type pars: numpy.ndarray</span>
<span class="sd">    :param z: Source redshift</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :return: Linear operator for gas density</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select values in the source region</span>
    <span class="n">kpcp</span><span class="o">=</span><span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rfit</span><span class="o">=</span><span class="n">rad</span><span class="o">*</span><span class="n">kpcp</span>
    <span class="n">npt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">npars</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Compute linear combination of basis functions in the source region</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">npt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npars</span><span class="p">,</span><span class="n">npt</span><span class="p">)</span>
    <span class="n">base</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rfit</span><span class="o">/</span><span class="n">rc</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">expon</span><span class="o">=-</span><span class="mf">3.</span><span class="o">*</span><span class="n">beta</span>
    <span class="n">func_base</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">expon</span><span class="p">)</span>
    <span class="n">cfact</span><span class="o">=</span><span class="n">gamma</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="n">gamma</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">beta</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">rc</span>
    <span class="n">fng</span><span class="o">=</span><span class="n">func_base</span><span class="o">*</span><span class="n">cfact</span>
    
    <span class="c1"># Recast into full matrix and add column for background</span>
    <span class="n">nptot</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfit</span><span class="p">)</span>
    <span class="n">Ktot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nptot</span><span class="p">,</span><span class="n">npars</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Ktot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="n">fng</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Ktot</span><span class="p">[:,</span><span class="n">npars</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">Ktot</span></div>

<div class="viewcode-block" id="Deproject_Multiscale_Stan"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject_Multiscale_Stan">[docs]</a><span class="k">def</span> <span class="nf">Deproject_Multiscale_Stan</span><span class="p">(</span><span class="n">deproj</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the multiscale deprojection optimization using the Stan backend</span>

<span class="sd">    :param deproj: Object containing the data and parameters</span>
<span class="sd">    :type deproj: pyproffit.Deproject</span>
<span class="sd">    :param bkglim: Limit beyond which it is assumed that the background dominates, i.e. the source is set to 0. If bkglim=None (default), the entire radial range is used</span>
<span class="sd">    :type bkglim: float</span>
<span class="sd">    :param nmcmc: Number of HMC points in the output sample</span>
<span class="sd">    :type nmcmc: int</span>
<span class="sd">    :param back: Input value for the background, around which a gaussian prior is set. If back=None (default), the input background value will be computed as the average of the source-free region</span>
<span class="sd">    :type back: float</span>
<span class="sd">    :param samplefile: Path to output file to write the output samples. If samplefile=None (default), the data are not written to file and only loaded into memory</span>
<span class="sd">    :type samplefile: str</span>
<span class="sd">    :param nrc: Number of core radii. If nrc=None (default), the number of core radiis will be defined on-the-fly</span>
<span class="sd">    :type nrc: int</span>
<span class="sd">    :param nbetas: Number of beta values. Default=6</span>
<span class="sd">    :type nbetas: int</span>
<span class="sd">    :param depth: Set the max_treedepth parameter for Stan (default=10)</span>
<span class="sd">    :type depth: int</span>
<span class="sd">    :param min_beta: Minimum value of beta. Default=0.6</span>
<span class="sd">    :type min_beta: float</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">deproj</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
    <span class="n">erad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">counts</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span>
    <span class="n">exposure</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span>
    <span class="n">bkgcounts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgcounts</span>

    <span class="c1"># Define maximum radius for source deprojection, assuming we have only background for r&gt;bkglim</span>
    <span class="k">if</span> <span class="n">bkglim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bkglim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rad</span><span class="o">+</span><span class="n">erad</span><span class="p">)</span>
        <span class="n">deproj</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deproj</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="n">backreg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span><span class="o">&gt;</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="n">backreg</span><span class="p">])</span>

    <span class="c1"># Set source region</span>
    <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="n">bkglim</span><span class="p">)</span>
    <span class="n">nptfit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">])</span>

    <span class="c1"># Set vector with list of parameters</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">nrc</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">,</span> <span class="n">min_beta</span><span class="p">)</span>

    <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>

    <span class="c1"># Compute linear combination kernel</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">calc_linear_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">psfmat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">npt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">back</span><span class="p">)</span> <span class="ow">or</span> <span class="n">back</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>

    <span class="n">norm0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">testval</span><span class="p">,</span><span class="n">npt</span><span class="p">),</span><span class="n">testbkg</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">pystan</span>
    <span class="kn">import</span> <span class="nn">stan_utility</span> <span class="k">as</span> <span class="nn">su</span>

    <span class="n">stan_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.stan_cache&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stan_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stan_dir</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">    int&lt;lower=0&gt; N;</span>
<span class="s2">    int&lt;lower=0&gt; M;</span>
<span class="s2">    int cts_tot[N];</span>
<span class="s2">    vector[N] cts_back;</span>
<span class="s2">    matrix[N,M] K;</span>
<span class="s2">    vector[M] norm0;</span>
<span class="s2">    }</span>
<span class="s2">    parameters {</span>
<span class="s2">    vector[M] log_norm;</span>
<span class="s2">    }</span>
<span class="s2">    transformed parameters{</span>
<span class="s2">    vector[M] norm = exp(log_norm);</span>
<span class="s2">    }</span>
<span class="s2">    model {</span>
<span class="s2">    log_norm ~ normal(norm0,10);</span>
<span class="s2">    cts_tot ~ poisson(K * norm + cts_back);</span>
<span class="s2">    }&quot;&quot;&quot;</span>


    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;mybeta_GP.stan&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">su</span><span class="o">.</span><span class="n">compile_model</span><span class="p">(</span><span class="s1">&#39;mybeta_GP.stan&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;model_GP&#39;</span><span class="p">)</span>

    <span class="n">datas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">cts_tot</span><span class="o">=</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">cts_back</span><span class="o">=</span><span class="n">bkgcounts</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="o">=</span><span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">norm0</span><span class="o">=</span><span class="n">norm0</span><span class="p">)</span>
    <span class="n">tinit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running MCMC...&#39;</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">sampling</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">datas</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_treedepth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Total computing time is: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39; minutes&#39;</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="s1">&#39;log_norm&#39;</span><span class="p">]</span>

    <span class="c1"># Get chains and save them to file</span>

    <span class="k">if</span> <span class="n">samplefile</span> <span class="ow">is</span> <span class="ow">not</span>  <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="o">+</span><span class="s1">&#39;.par&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">nbetas</span><span class="p">,</span><span class="n">nbetas</span><span class="p">,</span><span class="n">min_beta</span><span class="p">,</span><span class="n">nmcmc</span><span class="p">]),</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;stan&#39;</span><span class="p">)</span>

    <span class="c1"># Compute output deconvolved brightness profile</span>
    <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
    <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">bfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">npt</span><span class="p">]))</span>
    <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">deproj</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">pmc</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="n">pmch</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">bfit</span></div>
    
    
    
<div class="viewcode-block" id="Deproject_Multiscale_PyMC3"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject_Multiscale_PyMC3">[docs]</a><span class="k">def</span> <span class="nf">Deproject_Multiscale_PyMC3</span><span class="p">(</span><span class="n">deproj</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the multiscale deprojection optimization using the PyMC3 backend</span>

<span class="sd">    :param deproj: Object containing the data and parameters</span>
<span class="sd">    :type deproj: pyproffit.Deproject</span>
<span class="sd">    :param bkglim: Limit beyond which it is assumed that the background dominates, i.e. the source is set to 0. If bkglim=None (default), the entire radial range is used</span>
<span class="sd">    :type bkglim: float</span>
<span class="sd">    :param nmcmc: Number of HMC points in the output sample</span>
<span class="sd">    :type nmcmc: int</span>
<span class="sd">    :param back: Input value for the background, around which a gaussian prior is set. If back=None (default), the input background value will be computed as the average of the source-free region</span>
<span class="sd">    :type back: float</span>
<span class="sd">    :param samplefile: Path to output file to write the output samples. If samplefile=None (default), the data are not written to file and only loaded into memory</span>
<span class="sd">    :type samplefile: str</span>
<span class="sd">    :param nrc: Number of core radii. If nrc=None (default), the number of core radiis will be defined on-the-fly</span>
<span class="sd">    :type nrc: int</span>
<span class="sd">    :param nbetas: Number of beta values. Default=6</span>
<span class="sd">    :type nbetas: int</span>
<span class="sd">    :param min_beta: Minimum value of beta. Default=0.6</span>
<span class="sd">    :type min_beta: float</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prof</span> <span class="o">=</span> <span class="n">deproj</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
    <span class="n">erad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">counts</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span>
    <span class="n">exposure</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span>
    <span class="n">bkgcounts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgcounts</span>

    <span class="c1"># Define maximum radius for source deprojection, assuming we have only background for r&gt;bkglim</span>
    <span class="k">if</span> <span class="n">bkglim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bkglim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rad</span><span class="o">+</span><span class="n">erad</span><span class="p">)</span>
        <span class="n">deproj</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deproj</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="n">backreg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span><span class="o">&gt;</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="n">backreg</span><span class="p">])</span>

    <span class="c1"># Set source region</span>
    <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="n">bkglim</span><span class="p">)</span>
    <span class="n">nptfit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="n">sourcereg</span><span class="p">])</span>

    <span class="c1"># Set vector with list of parameters</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">nrc</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">,</span> <span class="n">min_beta</span><span class="p">)</span>

    <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>

    <span class="c1"># Compute linear combination kernel</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">calc_linear_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">psfmat</span><span class="p">)</span>
    <span class="n">basic_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">npt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">back</span><span class="p">)</span> <span class="ow">or</span> <span class="n">back</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">basic_model</span><span class="p">:</span>
        <span class="c1"># Priors for unknown model parameters</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;coefs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">testval</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">npt</span><span class="p">)</span>
        <span class="n">bkgd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">testbkg</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ctot</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">coefs</span><span class="p">,</span> <span class="n">bkgd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Expected value of outcome</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ctot</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">al</span><span class="p">)</span> <span class="o">+</span> <span class="n">bkgcounts</span>

        <span class="c1"># Likelihood (sampling distribution) of observations</span>
        <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">counts</span><span class="p">)</span>

    <span class="n">tinit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running MCMC...&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">basic_model</span><span class="p">:</span>
        <span class="n">tm</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nmcmc</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">tm</span><span class="p">)</span>
        <span class="c1">#trace = pm.sample(nmcmc)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Total computing time is: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39; minutes&#39;</span><span class="p">)</span>

    <span class="c1"># Get chains and save them to file</span>
    <span class="n">sampc</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s1">&#39;coefs&#39;</span><span class="p">)</span>
    <span class="n">sampb</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampc</span><span class="p">,</span> <span class="n">sampb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">samplefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="o">+</span><span class="s1">&#39;.par&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">nbetas</span><span class="p">,</span><span class="n">nbetas</span><span class="p">,</span><span class="n">min_beta</span><span class="p">,</span><span class="n">nmcmc</span><span class="p">]),</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;pymc3&#39;</span><span class="p">)</span>

    <span class="c1"># Compute output deconvolved brightness profile</span>
    <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
    <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">bfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">npt</span><span class="p">]))</span>
    <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">deproj</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">pmc</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="n">pmch</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">bfit</span></div>



<div class="viewcode-block" id="MyDeprojVol"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.MyDeprojVol">[docs]</a><span class="k">class</span> <span class="nc">MyDeprojVol</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute the projection volumes</span>

<span class="sd">    :param radin: Array of inner radii of the bins</span>
<span class="sd">    :type radin: class:`numpy.ndarray`</span>
<span class="sd">    :param radout: Array of outer radii of the bins</span>
<span class="sd">    :type radout: class:`numpy.ndarray`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radin</span><span class="p">,</span> <span class="n">radout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for class MyDeprojVol</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radin</span><span class="o">=</span><span class="n">radin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radot</span><span class="o">=</span><span class="n">radout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="MyDeprojVol.deproj_vol"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.MyDeprojVol.deproj_vol">[docs]</a>    <span class="k">def</span> <span class="nf">deproj_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the projection volumes</span>

<span class="sd">        :return: Volume matrix</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">###############volume=deproj_vol(radin,radot)</span>
        <span class="n">ri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radin</span><span class="p">)</span>
        <span class="n">ro</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radout</span><span class="p">)</span>

        <span class="n">diftot</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ri</span><span class="p">)):</span>
            <span class="n">dif</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ro</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ro</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span>
            <span class="n">diftot</span><span class="o">=</span><span class="n">diftot</span><span class="o">+</span><span class="n">dif</span>
            <span class="n">ro</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diftot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; DEPROJ_VOL: WARNING - abs(ri(i)-ro(i-1)) differs by&#39;</span><span class="p">,</span><span class="n">diftot</span><span class="p">,</span><span class="s1">&#39; percent&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; DEPROJ_VOL: Fixing up radii ... &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dif</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ro</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ro</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span>
                <span class="n">diftot</span><span class="o">=</span><span class="n">diftot</span><span class="o">+</span><span class="n">dif</span>
        <span class="n">nbin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span>
        <span class="n">volconst</span><span class="o">=</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">volmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbin</span><span class="p">,</span> <span class="n">nbin</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">iring</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nbin</span><span class="p">))):</span>
            <span class="n">volmat</span><span class="p">[</span><span class="n">iring</span><span class="p">,</span><span class="n">iring</span><span class="p">]</span><span class="o">=</span><span class="n">volconst</span> <span class="o">*</span> <span class="n">ro</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">ri</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">/</span><span class="n">ro</span><span class="p">[</span><span class="n">iring</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>
            <span class="k">for</span> <span class="n">ishell</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iring</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nbin</span><span class="p">))):</span>
                <span class="n">f1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">ri</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">/</span><span class="n">ro</span><span class="p">[</span><span class="n">ishell</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">ro</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">/</span><span class="n">ro</span><span class="p">[</span><span class="n">ishell</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>
                <span class="n">f2</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">ri</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">/</span><span class="n">ri</span><span class="p">[</span><span class="n">ishell</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">ro</span><span class="p">[</span><span class="n">iring</span><span class="p">]</span><span class="o">/</span><span class="n">ri</span><span class="p">[</span><span class="n">ishell</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>
                <span class="n">volmat</span><span class="p">[</span><span class="n">ishell</span><span class="p">,</span><span class="n">iring</span><span class="p">]</span><span class="o">=</span><span class="n">volconst</span> <span class="o">*</span> <span class="p">(</span><span class="n">f1</span><span class="o">*</span><span class="n">ro</span><span class="p">[</span><span class="n">ishell</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">f2</span><span class="o">*</span><span class="n">ri</span><span class="p">[</span><span class="n">ishell</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">volmat</span><span class="p">[</span><span class="n">ishell</span><span class="p">,</span><span class="n">iring</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">exit</span><span class="p">()</span>

        <span class="n">volume2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">volmat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">volume2</span></div></div>

<div class="viewcode-block" id="medsmooth"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.medsmooth">[docs]</a><span class="k">def</span> <span class="nf">medsmooth</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Smooth a given profile by taking the median value of surrounding points instead of the initial value</span>

<span class="sd">    :param prof: Input profile to be smoothed</span>
<span class="sd">    :type prof: numpy.ndarray</span>
<span class="sd">    :return: Smoothd profile</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">nbin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nbin</span><span class="p">,</span><span class="n">width</span><span class="p">))</span>
    <span class="n">xx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">prof</span>
    <span class="n">xx</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">smoothed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">smoothed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">width</span><span class="p">])</span>
    <span class="n">smoothed</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Y0</span><span class="o">=</span><span class="mf">3.</span><span class="o">*</span><span class="n">prof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">prof</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Y0</span><span class="p">,</span><span class="n">prof</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prof</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">smoothed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">Y0</span><span class="o">=</span><span class="mf">3.</span><span class="o">*</span><span class="n">prof</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">prof</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Y0</span><span class="p">,</span><span class="n">prof</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">prof</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">smoothed</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">smoothed</span></div>

<div class="viewcode-block" id="EdgeCorr"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.EdgeCorr">[docs]</a><span class="k">def</span> <span class="nf">EdgeCorr</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">rin_cm</span><span class="p">,</span><span class="n">rout_cm</span><span class="p">,</span><span class="n">em0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For Onion Peeling deprojection, correct for edge effects by estimating the contribution of flux beyond the edge, using McLaughlin+99 method</span>

<span class="sd">    :param nbin: Number of bins in input profile</span>
<span class="sd">    :type nbin: int</span>
<span class="sd">    :param rin_cm: Inner radii of the bins in cm</span>
<span class="sd">    :type rin_cm: numpy.ndarray</span>
<span class="sd">    :param rout_cm: Outer radii of the bins in cm</span>
<span class="sd">    :type rout_cm: numpy.ndarray</span>
<span class="sd">    :param em0: Deprojected emissivity profile before edge correction</span>
<span class="sd">    :type em0: numpy.ndarray</span>
<span class="sd">    :return: Edge-corrected deprojected profile</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># edge correction</span>
    <span class="n">mrad</span> <span class="o">=</span> <span class="p">[</span><span class="n">rin_cm</span><span class="p">[</span><span class="n">nbin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">nbin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">edge0</span> <span class="o">=</span> <span class="p">(</span><span class="n">mrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">rout_cm</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="n">edge1</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">rout_cm</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">rout_cm</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">edge2</span> <span class="o">=</span> <span class="n">rout_cm</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rout_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">edget</span> <span class="o">=</span> <span class="n">edge0</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">edge1</span> <span class="o">-</span> <span class="n">edge2</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rin_cm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">edge0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">edge1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">edge2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">edget</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">edge1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rout_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">rin_cm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rout_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">rin_cm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rout_cm</span><span class="p">[</span><span class="n">nbin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">rin_cm</span><span class="p">[</span><span class="n">nbin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">edget</span> <span class="o">*</span> <span class="n">surf</span> <span class="o">*</span> <span class="n">em0</span><span class="p">[</span><span class="n">nbin</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">em0</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corr</span></div>

<div class="viewcode-block" id="OP"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.OP">[docs]</a><span class="k">def</span> <span class="nf">OP</span><span class="p">(</span><span class="n">deproj</span><span class="p">,</span><span class="n">nmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run standard Onion Peeling deprojection including edge correction</span>

<span class="sd">    :param deproj: Input data</span>
<span class="sd">    :type deproj: pyproffit.Deproject</span>
<span class="sd">    :param nmc: Number of Monte Carlo realizations of the profile to compute the uncertainties (default=1000)</span>
<span class="sd">    :type nmc: int</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Standard onion peeling</span>
    <span class="n">prof</span><span class="o">=</span><span class="n">deproj</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">nbin</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span>
    <span class="n">rinam</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>
    <span class="n">routam</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>
    <span class="n">area</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">routam</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">rinam</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># full area in arcmin^2</span>

    <span class="c1"># Projection volumes</span>
    <span class="k">if</span> <span class="n">deproj</span><span class="o">.</span><span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deproj</span><span class="o">.</span><span class="n">cf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amin2kpc</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">deproj</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">rin_cm</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span><span class="p">)</span><span class="o">*</span><span class="n">amin2kpc</span><span class="o">*</span><span class="n">Mpc</span><span class="o">/</span><span class="mf">1e3</span>
        <span class="n">rout_cm</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span><span class="p">)</span><span class="o">*</span><span class="n">amin2kpc</span><span class="o">*</span><span class="n">Mpc</span><span class="o">/</span><span class="mf">1e3</span>
        <span class="n">x</span><span class="o">=</span><span class="n">MyDeprojVol</span><span class="p">(</span><span class="n">rin_cm</span><span class="p">,</span><span class="n">rout_cm</span><span class="p">)</span>
        <span class="n">vol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">deproj_vol</span><span class="p">())</span>
        <span class="n">dlum</span><span class="o">=</span><span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">deproj</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">Mpc</span>
        <span class="n">K2em</span><span class="o">=</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e14</span><span class="o">*</span><span class="n">dlum</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">deproj</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">deproj</span><span class="o">.</span><span class="n">nhc</span><span class="o">/</span><span class="n">deproj</span><span class="o">.</span><span class="n">cf</span>

        <span class="c1"># Projected emission measure profiles</span>
        <span class="n">em0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span> <span class="o">*</span> <span class="n">K2em</span> <span class="o">*</span> <span class="n">area</span>
        <span class="n">e_em0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">eprof</span> <span class="o">*</span> <span class="n">K2em</span> <span class="o">*</span> <span class="n">area</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">EdgeCorr</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span> <span class="n">rin_cm</span><span class="p">,</span> <span class="n">rout_cm</span><span class="p">,</span> <span class="n">em0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">MyDeprojVol</span><span class="p">(</span><span class="n">rinam</span><span class="p">,</span><span class="n">routam</span><span class="p">)</span>
        <span class="n">vol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">deproj_vol</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
        <span class="n">em0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span> <span class="o">*</span> <span class="n">area</span>
        <span class="n">e_em0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span> <span class="o">*</span> <span class="n">area</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">EdgeCorr</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">rinam</span><span class="p">,</span><span class="n">routam</span><span class="p">)</span>

    <span class="c1"># Deproject and propagate error using Monte Carlo</span>
    <span class="n">emres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">e_em0</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">em0</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span>
    <span class="n">allres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">emres</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ct</span><span class="p">))</span>
    <span class="n">ev0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bsm</span> <span class="o">=</span> <span class="n">medsmooth</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>

    <span class="n">deproj</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">bsm</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="n">bsm</span> <span class="o">-</span> <span class="n">ev0</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="n">bsm</span> <span class="o">+</span> <span class="n">ev0</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">rout</span> <span class="o">=</span> <span class="n">routam</span>

    <span class="n">deproj</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="n">medsmooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">bsm</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bsm</span><span class="p">)))</span>
    <span class="n">edens</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bsm</span><span class="p">))</span><span class="o">*</span><span class="n">ev0</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">dens_lo</span> <span class="o">=</span> <span class="n">deproj</span><span class="o">.</span><span class="n">dens</span> <span class="o">-</span> <span class="n">edens</span>
    <span class="n">deproj</span><span class="o">.</span><span class="n">dens_hi</span> <span class="o">=</span> <span class="n">deproj</span><span class="o">.</span><span class="n">dens</span> <span class="o">+</span> <span class="n">edens</span>

    <span class="n">deproj</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">routam</span><span class="p">)</span></div>


<div class="viewcode-block" id="Deproject"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject">[docs]</a><span class="k">class</span> <span class="nc">Deproject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    pyproffit.Deproject class to perform all calculations of deprojection, density profile, gas mass, count rate, and luminosity</span>

<span class="sd">    :param z: Source redshift. If z=None, only the surface brightness reconstruction can be done.</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param profile: Object of type :class:`pyproffit.profextract.Profile` containing the surface brightness profile data</span>
<span class="sd">    :type profile: class:`pyproffit.profextract.Profile`</span>
<span class="sd">    :param cf: Conversion factor from count rate to emissivity. If cf=None, only the surface brightness reconstruction can be done.</span>
<span class="sd">    :type cf: float</span>
<span class="sd">    :param f_abund: Solar abundance table to compute the electron-to-proton ratio and mean molecular weight. Available tables are &#39;aspl&#39; (Aspling+09, default), &#39;angr&#39; (Anders &amp; Grevesse 89), and &#39;grsa&#39; (Grevesse &amp; Sauval 98)</span>
<span class="sd">    :type f_abund: str</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">profile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">f_abund</span><span class="o">=</span><span class="s1">&#39;aspl&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for class pyproffit.Deproject</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="n">cf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens_lo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens_hi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covmat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmcl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_counts</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_lo</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_hi</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1"># mu_e: mean molecular weight per electron in pristine fully ionized gas with given abundance table</span>
        <span class="c1"># mup: mean molecular weight per particle  in pristine fully ionized gas with given abundance table</span>
        <span class="c1"># nhc: conversion factor from H n-density to e- n-density</span>

        <span class="k">if</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;angr&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8337</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.6125</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1738</span>
        <span class="k">elif</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;aspl&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8527</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.5994</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1548</span>
        <span class="k">elif</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;grsa&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8520</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.6000</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1555</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># aspl default</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8527</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.5994</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1548</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span><span class="o">=</span><span class="n">nhc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mup</span><span class="o">=</span><span class="n">mup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_e</span><span class="o">=</span><span class="n">mu_e</span>


<div class="viewcode-block" id="Deproject.Multiscale"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.Multiscale">[docs]</a>    <span class="k">def</span> <span class="nf">Multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;pymc3&#39;</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run Multiscale deprojection using the method described in Eckert+20</span>

<span class="sd">        :param backend: Backend to run the optimization problem. Available backends are &#39;pymc3&#39; (default) and &#39;stan&#39;</span>
<span class="sd">        :type backend: strr</span>
<span class="sd">        :param nmcmc: Number of HMC points in the output sample</span>
<span class="sd">        :type nmcmc: int</span>
<span class="sd">        :param bkglim: Limit beyond which it is assumed that the background dominates, i.e. the source is set to 0. If bkglim=None (default), the entire radial range is used</span>
<span class="sd">        :type bkglim: float</span>
<span class="sd">        :param back: Input value for the background, around which a gaussian prior is set. If back=None (default), the input background value will be computed as the average of the source-free region</span>
<span class="sd">        :type back: float</span>
<span class="sd">        :param samplefile: Path to output file to write the output samples. If samplefile=None (default), the data are not written to file and only loaded into memory</span>
<span class="sd">        :type samplefile: str</span>
<span class="sd">        :param nrc: Number of core radii. If nrc=None (default), the number of core radiis will be defined on-the-fly</span>
<span class="sd">        :type nrc: int</span>
<span class="sd">        :param nbetas: Number of beta values. Default=6</span>
<span class="sd">        :type nbetas: int</span>
<span class="sd">        :param depth: Set the max_treedepth parameter for Stan (default=10)</span>
<span class="sd">        :type depth: int</span>
<span class="sd">        :param min_beta: Minimum value of beta. Default=0.6</span>
<span class="sd">        :type min_beta: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back</span><span class="o">=</span><span class="n">back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span>
        <span class="k">if</span> <span class="n">backend</span><span class="o">==</span><span class="s1">&#39;pymc3&#39;</span><span class="p">:</span>
            <span class="n">Deproject_Multiscale_PyMC3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span><span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backend</span><span class="o">==</span><span class="s1">&#39;stan&#39;</span><span class="p">:</span>
            <span class="n">Deproject_Multiscale_Stan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span><span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown method &#39;</span><span class="o">+</span><span class="n">backend</span><span class="p">)</span></div>


<div class="viewcode-block" id="Deproject.OnionPeeling"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.OnionPeeling">[docs]</a>    <span class="k">def</span> <span class="nf">OnionPeeling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run standard Onion Peeling deprojection using the Kriss+83 method and the McLaughlin+99 edge correction</span>

<span class="sd">        :param nmc: Number of Monte Carlo realizations of the profile to compute the uncertainties (default=1000)</span>
<span class="sd">        :type nmc: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">OP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nmc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Deproject.PlotDensity"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.PlotDensity">[docs]</a>    <span class="k">def</span> <span class="nf">PlotDensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xscale</span><span class="o">=</span><span class="s1">&#39;kpc&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the loaded density profile</span>

<span class="sd">        :param outfile: Output file name. If outfile=None (default) plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :param xscale: Choose whether the x axis should be in unit of &#39;kpc&#39; (default), &#39;arcmin&#39;, or &#39;both&#39;, in which case two axes are drawn at the top and the bottom of the plot</span>
<span class="sd">        :type xscale: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Plot extracted profile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No profile extracted&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No density profile extracted&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">xscale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span><span class="s1">&#39;kpc&#39;</span><span class="p">,</span><span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">xscale</span><span class="o">=</span><span class="s1">&#39;kpc&#39;</span>

        <span class="n">sourcereg_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rout</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">rkpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rout</span><span class="p">[</span><span class="n">sourcereg_out</span><span class="p">]</span> <span class="o">*</span> <span class="n">kpcp</span>

        <span class="n">rout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rout</span><span class="p">[</span><span class="n">sourcereg_out</span><span class="p">]</span>
        <span class="c1">#erkpc = self.profile.ebins * kpcp</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$n_</span><span class="si">{H}</span><span class="s1">$ [cm$^{-3}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;kpc&#39;</span> <span class="ow">or</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_lo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_hi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [kpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_lo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_hi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [arcmin]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">limx</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">limx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span> <span class="n">kpcp</span><span class="p">,</span><span class="n">limx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span> <span class="n">kpcp</span><span class="p">])</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [arcmin]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

        <span class="c1">#ax.errorbar(rkpc, self.dens, xerr=erkpc, yerr=[self.dens-self.dens_lo,self.dens_hi-self.dens], fmt=&#39;.&#39;, color=&#39;C0&#39;, elinewidth=2, markersize=7, capsize=3)</span>

        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Deproject.Density"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.Density">[docs]</a>    <span class="k">def</span> <span class="nf">Density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a density profile from a multiscale reconstruction</span>

<span class="sd">        :param rout: Radial binning of the density profile. If rout=None, the original binning of the surface brightness profile is used</span>
<span class="sd">        :type rout: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transf</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1e-14</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span> <span class="o">/</span> <span class="n">Mpc</span> <span class="o">*</span> <span class="mf">1e3</span>
            <span class="n">pardens</span> <span class="o">=</span> <span class="n">list_params_density</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sourcereg_out</span><span class="o">=</span><span class="n">sourcereg</span>
                <span class="n">rout</span><span class="o">=</span><span class="n">rad</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sourcereg_out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rout</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

            <span class="n">rd</span> <span class="o">=</span> <span class="n">rout</span><span class="p">[</span><span class="n">sourcereg_out</span><span class="p">]</span>
            <span class="n">Kdens</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">alldens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kdens</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">/</span> <span class="n">cf</span> <span class="o">*</span> <span class="n">transf</span><span class="p">)</span>  <span class="c1"># [0:nptfit, :]</span>
            <span class="n">covmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">alldens</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covmat</span> <span class="o">=</span> <span class="n">covmat</span>
            <span class="n">pmcd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pmcdl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pmcdh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="n">pmcd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dens_lo</span> <span class="o">=</span> <span class="n">pmcdl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dens_hi</span> <span class="o">=</span> <span class="n">pmcdh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rout</span><span class="o">=</span><span class="n">rout</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No redshift and/or conversion factor, nothing to do&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Deproject.PlotSB"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.PlotSB">[docs]</a>    <span class="k">def</span> <span class="nf">PlotSB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the surface brightness profile reconstructed after applying the multiscale deprojection and PSF deconvolution technique, and compare it with the input brightness profile</span>

<span class="sd">        :param outfile: File name of saving the output figure. If outfile=None (default), plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No profile extracted&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No reconstruction available&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">prof</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">])</span>
        <span class="n">ax_res</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">])</span>

        <span class="n">ax_res</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [arcmin]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SB [counts s$^{-1}$ arcmin$^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="c1">#ax.errorbar(prof.bins, prof.profile, xerr=prof.ebins, yerr=prof.eprof, fmt=&#39;o&#39;, color=&#39;black&#39;, elinewidth=2,</span>
        <span class="c1">#            markersize=7, capsize=0, mec=&#39;black&#39;, label=&#39;Bkg - subtracted Data&#39;)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">counts</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">ebins</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">eprof</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgprof</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Particle background&#39;</span><span class="p">)</span>

        <span class="c1"># plt.errorbar(self.profile.bins, self.sb, xerr=self.profile.ebins, yerr=[self.sb-self.sb_lo,self.sb_hi-self.sb], fmt=&#39;o&#39;, color=&#39;blue&#39;, elinewidth=2,  markersize=7, capsize=0,mec=&#39;blue&#39;,label=&#39;Reconstruction&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source model&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb_lo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb_hi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sky background&#39;</span><span class="p">)</span>

        <span class="c1">#compute SB profile without bkg subtraction to get residuals on fit</span>
        <span class="c1"># Set vector with list of parameters</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="c1"># Compute output deconvolved brightness profile</span>
        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator_psf</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span><span class="p">,</span> <span class="n">psfmat</span><span class="p">)</span>
        <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">bfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">npt</span><span class="p">]))</span>
        <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgprof</span>
        <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgprof</span>
        <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgprof</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total model&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">pmcl</span><span class="p">,</span> <span class="n">pmch</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmcl</span><span class="o">=</span><span class="n">pmcl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmch</span><span class="o">=</span><span class="n">pmch</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmc</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">counts</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pmc</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span><span class="p">)</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span>
        <span class="n">veff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">veff</span> <span class="o">&gt;</span> <span class="n">vmin</span><span class="p">:</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">veff</span><span class="o">*</span><span class="mf">1.2</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
        <span class="n">ii</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">)])</span>
        <span class="n">ax_res</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmin</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Deproject.CountRate"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.CountRate">[docs]</a>    <span class="k">def</span> <span class="nf">CountRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the model count rate integrated between radii a and b. Optionally, the count rate distribution can be plotted and saved.</span>

<span class="sd">        :param a: Inner integration boundary in arcmin</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param b: Outer integration boundary in arcmin</span>
<span class="sd">        :type b: float</span>
<span class="sd">        :param plot: Plot the posterior count rate distribution (default=True)</span>
<span class="sd">        :type plot: bool</span>
<span class="sd">        :param outfile: Output file name to save the figure. If outfile=None, plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :return: Median count rate, 16th and 84th percentiles</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no MCMC samples found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Set source region</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="c1"># Avoid diverging profiles in the center by cutting to the innermost points, if necessary</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>

        <span class="c1"># Set vector with list of parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">Kint</span> <span class="o">=</span> <span class="n">calc_int_operator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">allint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kint</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">medint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">intlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">inthi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructed count rate: </span><span class="si">%g</span><span class="s1"> (</span><span class="si">%g</span><span class="s1"> , </span><span class="si">%g</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medint</span><span class="p">,</span> <span class="n">intlo</span><span class="p">,</span> <span class="n">inthi</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span>
                       <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="c1"># plt.yscale(&#39;log&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">allint</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">allint</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Count Rate [cts/s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span>  <span class="n">medint</span><span class="p">,</span><span class="n">intlo</span><span class="p">,</span><span class="n">inthi</span></div>

<div class="viewcode-block" id="Deproject.Ncounts"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.Ncounts">[docs]</a>    <span class="k">def</span> <span class="nf">Ncounts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the total model number of counts. Optionally, the posterior distribution can be plotted and saved.</span>

<span class="sd">        :param plot: Plot the posterior distribution of number of counts (default=True)</span>
<span class="sd">        :type plot: bool</span>
<span class="sd">        :param outfile: Output file name to save the figure. If outfile=None, plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :return: Median count rate, 16th and 84th percentiles</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no MCMC samples found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Set source region</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span>

        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>

        <span class="c1"># Set vector with list of parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">calc_linear_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">psfmat</span><span class="p">)</span>
        <span class="n">npars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">K</span><span class="p">[:,</span><span class="n">npars</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">allnc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_counts</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_lo</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_hi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allnc</span><span class="p">,[</span><span class="mf">50.</span><span class="p">,</span><span class="mf">50.</span><span class="o">-</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="mf">50.</span><span class="o">+</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ncv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allnc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pnc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ncv</span><span class="p">)</span>
        <span class="n">pncl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ncv</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">pnch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ncv</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructed counts: </span><span class="si">%g</span><span class="s1"> (</span><span class="si">%g</span><span class="s1"> , </span><span class="si">%g</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pnc</span><span class="p">,</span> <span class="n">pncl</span><span class="p">,</span> <span class="n">pnch</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span>
                       <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="c1"># plt.yscale(&#39;log&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ncv</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$N_</span><span class="si">{count}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span>  <span class="n">pnc</span><span class="p">,</span><span class="n">pncl</span><span class="p">,</span><span class="n">pnch</span></div>


    <span class="c1"># Compute Mgas within radius in kpc</span>
<div class="viewcode-block" id="Deproject.Mgas"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.Mgas">[docs]</a>    <span class="k">def</span> <span class="nf">Mgas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the posterior cumulative gas mass within a given radius. . Optionally, the posterior distribution can be plotted and saved.</span>

<span class="sd">        :param radius: Gas mass integration radius in kpc</span>
<span class="sd">        :type radius: float</span>
<span class="sd">        :param plot: Plot the posterior Mgas distribution (default=True)</span>
<span class="sd">        :type plot: bool</span>
<span class="sd">        :param outfile: Output file name to save the figure. If outfile=None, plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :return: Median count rate, 16th and 84th percentiles</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no gas density profile found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">rkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="n">erkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="n">nhconv</span> <span class="o">=</span>  <span class="n">mh</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span> <span class="o">*</span> <span class="n">kpc</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">msun</span>  <span class="c1"># Msun/kpc^3</span>

        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="n">transf</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1e-14</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span> <span class="o">/</span> <span class="n">Mpc</span> <span class="o">*</span> <span class="mf">1e3</span>
        <span class="n">pardens</span> <span class="o">=</span> <span class="n">list_params_density</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">Kdens</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># All gas density profiles</span>
        <span class="n">alldens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kdens</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">*</span> <span class="n">transf</span><span class="p">)</span>  <span class="c1"># [0:nptfit, :]</span>

        <span class="c1"># Matrix containing integration volumes</span>
        <span class="n">volmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rkpc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">erkpc</span><span class="p">,</span> <span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">),</span><span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Compute Mgas profile as cumulative sum over the volume</span>
        <span class="n">mgas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">alldens</span> <span class="o">*</span> <span class="n">nhconv</span> <span class="o">*</span> <span class="n">volmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Interpolate at the radius of interest</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="n">mgas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mgasdist</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">mg</span><span class="p">,</span> <span class="n">mgl</span><span class="p">,</span> <span class="n">mgh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mgasdist</span><span class="p">,[</span><span class="mf">50.</span><span class="p">,</span><span class="mf">50.</span><span class="o">-</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="mf">50.</span><span class="o">+</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span>
                       <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="c1"># plt.yscale(&#39;log&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mgasdist</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$M_</span><span class="si">{gas}</span><span class="s1"> [M_\odot]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mg</span><span class="p">,</span><span class="n">mgl</span><span class="p">,</span><span class="n">mgh</span></div>

<div class="viewcode-block" id="Deproject.PlotMgas"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.PlotMgas">[docs]</a>    <span class="k">def</span> <span class="nf">PlotMgas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;kpc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the cumulative gas mass profile from the output of a reconstruction</span>

<span class="sd">        :param rout: Radial binning of the gas mass profile. If rout=None, the original binning of the surface brightness profile is used</span>
<span class="sd">        :type rout: numpy.ndarray</span>
<span class="sd">        :param outfile: Output file name to save the figure. If outfile=None, plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :param xscale: Choose whether the x axis should be in unit of &#39;kpc&#39; (default), &#39;arcmin&#39;, or &#39;both&#39;, in which case two axes are drawn at the top and the bottom of the plot</span>
<span class="sd">        :type xscale: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no gas density profile found&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">xscale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span><span class="s1">&#39;kpc&#39;</span><span class="p">,</span><span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">xscale</span><span class="o">=</span><span class="s1">&#39;kpc&#39;</span>


        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">rout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">*</span> <span class="n">kpcp</span>
            <span class="n">erkpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rkpc</span> <span class="o">=</span> <span class="n">rout</span> <span class="o">*</span> <span class="n">kpcp</span>
            <span class="n">erkpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rout</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rout</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kpcp</span>
        <span class="n">nhconv</span> <span class="o">=</span>  <span class="n">mh</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span> <span class="o">*</span> <span class="n">kpc</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">msun</span>  <span class="c1"># Msun/kpc^3</span>

        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="n">transf</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1e-14</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span> <span class="o">/</span> <span class="n">Mpc</span> <span class="o">*</span> <span class="mf">1e3</span>
        <span class="n">pardens</span> <span class="o">=</span> <span class="n">list_params_density</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sourcereg_out</span> <span class="o">=</span> <span class="n">sourcereg</span>
            <span class="n">rout</span> <span class="o">=</span> <span class="n">rad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sourcereg_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rout</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="n">Kdens</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rout</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># All gas density profiles</span>
        <span class="n">alldens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kdens</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">*</span> <span class="n">transf</span><span class="p">)</span>  <span class="c1"># [0:nptfit, :]</span>


        <span class="c1"># Matrix containing integration volumes</span>
        <span class="n">volmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rkpc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">erkpc</span><span class="p">,</span> <span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rout</span><span class="p">),</span> <span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Compute Mgas profile as cumulative sum over the volume</span>
        <span class="n">mgasdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">alldens</span> <span class="o">*</span> <span class="n">nhconv</span> <span class="o">*</span> <span class="n">volmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">mg</span><span class="p">,</span> <span class="n">mgl</span><span class="p">,</span> <span class="n">mgh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mgasdist</span><span class="p">,[</span><span class="mf">50.</span><span class="p">,</span><span class="mf">50.</span><span class="o">-</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="mf">50.</span><span class="o">+</span><span class="mf">68.3</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mg</span><span class="o">=</span><span class="n">mg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgl</span><span class="o">=</span><span class="n">mgl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgh</span><span class="o">=</span><span class="n">mgh</span>


        <span class="c1">#now compute mtot from mgas-mtot scaling relation</span>
        <span class="n">rho_cz</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Msun</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">kpc</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">Mgas</span> <span class="o">=</span> <span class="n">fbul19</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">Runit</span><span class="o">=</span><span class="s1">&#39;kpc&#39;</span><span class="p">)</span>

        <span class="n">Mgasdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Mgas</span><span class="p">,</span> <span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rout</span><span class="p">),</span> <span class="n">alldens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r500</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">rkpc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Mgasdist</span> <span class="o">/</span> <span class="n">mgasdist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="p">[</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m500</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m500_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m500_h</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">rho_cz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">rho_cz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_l</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">rho_cz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_h</span> <span class="o">**</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t500</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t500_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t500_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500</span><span class="o">/</span><span class="n">kpcp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_l</span><span class="o">/</span><span class="n">kpcp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r500_h</span><span class="o">/</span><span class="n">kpcp</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;kpc&#39;</span> <span class="ow">or</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="n">mg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gas mass&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rkpc</span><span class="p">,</span> <span class="n">mgl</span><span class="p">,</span> <span class="n">mgh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [kpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rout</span><span class="p">,</span> <span class="n">mg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gas mass&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rout</span><span class="p">,</span> <span class="n">mgl</span><span class="p">,</span> <span class="n">mgh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [arcmin]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$M_</span><span class="si">{gas}</span><span class="s1"> [M_\odot]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xscale</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">limx</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">limx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span> <span class="n">kpcp</span><span class="p">,</span><span class="n">limx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span> <span class="n">kpcp</span><span class="p">])</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius [arcmin]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Deproject.Reload"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.Reload">[docs]</a>    <span class="k">def</span> <span class="nf">Reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">samplefile</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reload the samples stored from a previous reconstruction run</span>

<span class="sd">        :param samplefile: Path to file containing the saved HMC samples</span>
<span class="sd">        :type samplefile: str</span>
<span class="sd">        :param bkglim: Limit beyond which it is assumed that the background dominates, i.e. the source is set to 0. This parameter needs to be the same as the value used to run the reconstruction. If bkglim=None (default), the entire radial range is used</span>
<span class="sd">        :type bkglim: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reload the output of a previous PyMC3 run</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">samplefile</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">samplefile</span><span class="o">+</span><span class="s1">&#39;.par&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmcmc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">samplefile</span><span class="o">+</span><span class="s1">&#39;.par&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no profile provided&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">erad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>

        <span class="k">if</span> <span class="n">bkglim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bkglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rad</span> <span class="o">+</span> <span class="n">erad</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>

        <span class="c1"># Set source region</span>
        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="n">bkglim</span><span class="p">)</span>

        <span class="c1"># Set vector with list of parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="c1"># Compute output deconvolved brightness profile</span>
        <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">bfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">npt</span><span class="p">]))</span>
        <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">pmc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="n">pmch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">bfit</span></div>

<div class="viewcode-block" id="Deproject.CSB"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.CSB">[docs]</a>    <span class="k">def</span> <span class="nf">CSB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rin</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span><span class="n">rout</span><span class="o">=</span><span class="mf">400.</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the surface brightness concentration from a loaded brightness profile reconstruction. The surface brightness concentration is defined as the ratio of fluxes computed within two apertures.</span>

<span class="sd">        :param rin: Lower aperture value in kpc (default=40)</span>
<span class="sd">        :type rin: float</span>
<span class="sd">        :param rout: Higher aperture value in kpc (default=400)</span>
<span class="sd">        :type rout: float</span>
<span class="sd">        :param plot: Plot the posterior CSB distribution (default=True)</span>
<span class="sd">        :type plot: bool</span>
<span class="sd">        :param outfile: Output file name to save the figure. If outfile=None, plot only to stdout</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        :return: Median count rate, 16th and 84th percentiles</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no profile reconstruction found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">kpcp</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span><span class="p">)</span>

        <span class="c1"># Set vector with list of parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_beta</span><span class="p">)</span>
        <span class="n">Kin</span> <span class="o">=</span> <span class="n">calc_int_operator</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">rin</span><span class="o">/</span><span class="n">kpcp</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">allvin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">Kout</span> <span class="o">=</span> <span class="n">calc_int_operator</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">rout</span><span class="o">/</span><span class="n">kpcp</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">allvout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kout</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">medcsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">((</span><span class="n">allvin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">allvout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">csblo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">((</span><span class="n">allvin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">allvout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">csbhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">((</span><span class="n">allvin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">allvout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface brightness concentration: </span><span class="si">%g</span><span class="s1"> (</span><span class="si">%g</span><span class="s1"> , </span><span class="si">%g</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medcsb</span><span class="p">,</span> <span class="n">csblo</span><span class="p">,</span> <span class="n">csbhi</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ax_size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span>
                       <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="c1"># plt.yscale(&#39;log&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">allvin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">allvout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">allvout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$C_</span><span class="si">{SB}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span>  <span class="n">medcsb</span><span class="p">,</span><span class="n">csblo</span><span class="p">,</span><span class="n">csbhi</span></div>


<div class="viewcode-block" id="Deproject.SaveAll"><a class="viewcode-back" href="../../pyproffit.html#pyproffit.deproject.Deproject.SaveAll">[docs]</a>    <span class="k">def</span> <span class="nf">SaveAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the results of a profile reconstruction into an output FITS file</span>
<span class="sd">        First extension is data</span>
<span class="sd">        Second extension is density</span>
<span class="sd">        Third extension is Mgas</span>
<span class="sd">        Fourth extension is PSF</span>

<span class="sd">        :param outfile: Output file name</span>
<span class="sd">        :type outfile: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output file name given&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RADIUS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">bins</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;WIDTH&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">ebins</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;cts s-1 arcmin-2&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">profile</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ERR_SB&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;cts s-1 arcmin-2&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">eprof</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;COUNTS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">counts</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;AREA&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;arcmin2&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;EFFEXP&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">effexp</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;BKG&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;cts s-1 arcmin-2&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">bkgprof</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;BKGCOUNTS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">bkgcounts</span><span class="p">))</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
                <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;DATA&#39;</span><span class="p">)</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;X_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;X_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X coordinate of center value&#39;</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Y coordinate of center value&#39;</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;RA_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cra</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DEC_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">cdec</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;RA_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Right ascension of center value&#39;</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;DEC_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Declination of center value&#39;</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Written by pyproffit (Eckert et al. 2011)&#39;</span>
                <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RADIUS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">bins</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL_TOT&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pmc</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL_TOT_L&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pmcl</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL_TOT_H&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pmch</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL_L&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sb_lo</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL_H&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sb_hi</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;COUNTS_MODEL&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_counts</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;COUNTS_MODEL_L&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_lo</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;COUNTS_MODEL_H&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_counts_hi</span><span class="p">))</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
                <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SB_MODEL&#39;</span><span class="p">)</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;BACKEND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;N_MCMC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmcmc</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;BKGLIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkglim</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SAMPLEFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplefile</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;N_RC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrc</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;N_BETAS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbetas</span>
                <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RADIUS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rout</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DENSITY&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dens</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DENSITY_L&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dens_lo</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DENSITY_H&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dens_hi</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MGAS&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mg</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MGAS_L&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mgl</span><span class="p">))</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MGAS_H&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mgh</span><span class="p">))</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
                <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;DENSITY&#39;</span><span class="p">)</span>
                <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">psfhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">psfmat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;PSF&#39;</span><span class="p">)</span>
                <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psfhdu</span><span class="p">)</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, D. Eckert

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>